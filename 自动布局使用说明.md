# 自动布局功能使用说明

## ✅ 问题已修复

自动布局功能已经重新设计并修复，现在可以正常工作了！

---

## 🎯 新的自动布局功能

### 核心改进

之前的自动布局只是简单地调整 wspace 和 hspace，但没有考虑整体图片尺寸和元素位置。

**新版本的改进**：
1. **智能计算图片尺寸**：根据行列数自动计算最优的图片宽度和高度
2. **优化子图间距**：根据布局密度调整间距，减少留白
3. **预留元素空间**：为色带、标题、比例尺等元素预留合适的空间
4. **提供预览尺寸建议**：告诉您最佳的预览像素尺寸
5. **用户反馈**：点击后会弹出对话框显示优化结果

---

## 📋 使用步骤

### 1. 打开多图页面

启动程序后，点击"多图"标签页。

### 2. 设置基本参数

在"布局与说明"区域：
- **行×列**：输入您需要的布局，例如 `1` × `4`

在"色带选项"区域：
- 勾选或取消"使用共享色带"
- 如果使用共享色带，选择位置（right/left/top/bottom）

在"子图元素（比例尺 & 北箭）"区域：
- 勾选或取消"使用共享比例尺"

### 3. 点击"自动布局"按钮

在"布局与说明"区域，点击 **"自动布局"** 按钮。

### 4. 查看优化结果

会弹出一个对话框，显示：
- ✅ 建议图片尺寸（英寸）
- ✅ 子图间距（wspace/hspace）
- ✅ 预览尺寸建议（像素）

例如：
```
✅ 布局优化完成！

建议图片尺寸：14.1 × 4.3 英寸
子图间距：wspace=0.02, hspace=0.25
预览尺寸建议：1833 × 559 像素

已自动填充间距参数。
建议在工具栏的'预览(px)'中填入推荐的预览尺寸，
然后点击'预览多图'查看效果。
```

### 5. 应用建议（可选）

- **间距已自动填充**：wspace 和 hspace 已经自动更新
- **预览尺寸**：在工具栏的"预览(px)"框中填入建议的宽×高
- **图片尺寸**：在"预览 宽×高 / DPI"中填入建议的英寸尺寸（可选）

### 6. 预览效果

点击"预览多图"查看优化后的效果。

---

## 🔍 优化算法说明

### 核心思想

1. **每个子图保持合理的宽高比**（约1.2:1，适合中国地图）
2. **根据行列数调整子图尺寸**：列数多时，每个子图稍小
3. **为元素预留空间**：
   - 顶部：为标题预留 0.8 英寸
   - 底部：为说明文字和色带预留 1.0-1.5 英寸
   - 左右：根据色带位置调整
4. **减少留白**：让子图尽可能大，同时保持合理间距

### 不同布局的优化策略

| 布局 | 子图宽度 | 子图高度 | wspace | hspace | 说明 |
|------|---------|---------|--------|--------|------|
| 1×4 | 3.2" | 3.5" | 0.02 | 0.25 | 横向紧凑，纵向宽松 |
| 2×4 | 3.2" | 3.0" | 0.02 | 0.20 | 横向紧凑，纵向适中 |
| 3×4 | 3.2" | 2.8" | 0.02 | 0.15 | 全面紧凑 |
| 1×3 | 3.5" | 3.5" | 0.05 | 0.25 | 横向适中 |
| 2×2 | 4.0" | 3.0" | 0.08 | 0.20 | 均衡布局 |
| 1×1 | 5.0" | 3.5" | 0.12 | 0.25 | 单图 |

### 色带位置的影响

- **右侧色带**：右边距增加到 1.2 英寸
- **左侧色带**：左边距增加到 1.2 英寸
- **底部色带**：底边距增加到 1.5 英寸
- **顶部色带**：顶边距增加到 1.2 英寸

---

## 💡 使用建议

### 1×4 横向布局（最常用）

```
步骤：
1. 行×列：1×4
2. 点击"自动布局"
3. 查看建议：约 14.1 × 4.3 英寸，预览 1833 × 559 像素
4. 在"预览(px)"中填入：1800 × 550（或建议值）
5. 勾选"使用共享比例尺"和"使用共享色带"
6. 色带位置：bottom
7. 比例尺样式：线段式
8. 点击"预览多图"

预期效果：
- 4个子图横向紧密排列
- 间距很小（wspace=0.02）
- 只在最后一个子图显示比例尺
- 色带在底部
- 图片铺满，留白少
```

### 2×4 布局

```
步骤：
1. 行×列：2×4
2. 点击"自动布局"
3. 查看建议：约 14.1 × 7.2 英寸，预览 1833 × 936 像素
4. 在"预览(px)"中填入建议值
5. 勾选"使用共享比例尺"和"使用共享色带"
6. 色带位置：right
7. 比例尺样式：线段式
8. 点击"预览多图"

预期效果：
- 8个子图，2行4列
- 横向间距小，纵向间距适中
- 只在最后一个子图显示比例尺
- 色带在右侧
```

### 3×4 布局

```
步骤：
1. 行×列：3×4
2. 点击"自动布局"
3. 查看建议：约 14.1 × 10.0 英寸，预览 1833 × 1300 像素
4. 在"预览(px)"中填入建议值
5. 勾选"使用共享比例尺"和"使用共享色带"
6. 色带位置：right
7. 比例尺样式：线段式
8. 点击"预览多图"

预期效果：
- 12个子图，3行4列
- 全面紧凑布局
- 只在最后一个子图显示比例尺
- 色带在右侧
```

---

## 🔧 手动微调

自动布局提供的是推荐值，您可以根据实际效果进行微调：

### 调整间距

- **wspace**：如果子图太挤，可以增加（如 0.02 → 0.05）
- **hspace**：如果行间距太小，可以增加（如 0.25 → 0.30）

### 调整图片尺寸

- **宽度**：如果整体太窄，可以增加宽度
- **高度**：如果整体太矮，可以增加高度

### 调整预览尺寸

- **预览(px)**：根据您的屏幕大小调整
- 建议：宽度 1200-2000，高度根据比例调整

---

## ❓ 常见问题

### Q1: 点击"自动布局"后没有反应？

**A**: 现在应该会弹出对话框显示优化结果。如果没有：
1. 检查是否填写了"行×列"
2. 查看是否有错误提示
3. 重新启动程序

### Q2: 优化后的图片尺寸太大或太小？

**A**: 自动布局计算的是最优尺寸，但您可以：
1. 手动调整"预览 宽×高"的值
2. 保持 wspace/hspace 不变
3. 调整 DPI 来改变输出分辨率

### Q3: 预览时图片还是挤在一起？

**A**: 可能的原因：
1. 预览像素尺寸设置不当 → 使用建议的预览尺寸
2. 图片本身的地理范围不同 → 检查输入的 TIF 文件
3. 元素位置参数需要调整 → 调整比例尺的 y_out 参数

### Q4: 比例尺和色带还是重叠？

**A**: 尝试：
1. 使用"共享比例尺"和"共享色带"
2. 调整比例尺的 y_out 参数（增大，如 0.10 → 0.15）
3. 如果色带在底部，调整色带的位置参数

### Q5: 能否自动填充预览尺寸？

**A**: 当前版本会在对话框中显示建议值，您需要手动复制到"预览(px)"框中。
这是为了让您有机会根据屏幕大小调整。

---

## 🎨 完整工作流程示例

### 场景：制作1×4横向排列的多图

```
1. 准备数据
   - 准备4个 TIF 文件
   - 确保它们的地理范围相同或相近

2. 打开GUI
   - 运行 python test_gui.py
   - 切换到"多图"标签页

3. 设置文件路径
   - 在"TIF文件列表"中输入4个文件路径（|分隔）

4. 设置布局
   - 行×列：1×4
   - 点击"自动布局"按钮
   - 查看弹出的建议（如：14.1×4.3英寸，1833×559像素）
   - 点击"确定"

5. 设置比例尺
   - 样式：线段式
   - ✓ 使用共享比例尺
   - 长度：留空（自动）
   - 字号：9

6. 设置色带
   - ✓ 使用共享色带
   - 位置：bottom
   - 宽度比例：0.10
   - 刻度数：6

7. 设置标题
   - 面板标题：(a) 图1|(b) 图2|(c) 图3|(d) 图4
   - 总说明文字：您的说明文字

8. 设置预览
   - 在工具栏"预览(px)"中填入：1800×550
   - 点击"预览多图"

9. 查看效果
   - 检查布局是否合理
   - 检查元素是否重叠
   - 如需调整，修改参数后重新预览

10. 导出
    - 设置导出路径
    - 点击"导出多图"
```

---

## 📊 技术细节

### 计算公式

```python
# 子图区域总宽度
subplot_area_width = ncols * subplot_width * (1 + wspace * (ncols-1) / ncols)

# 子图区域总高度
subplot_area_height = nrows * subplot_height * (1 + hspace * (nrows-1) / nrows)

# 总图宽度
fig_width = subplot_area_width + left_margin + right_margin

# 总图高度
fig_height = subplot_area_height + top_margin + bottom_margin

# 预览像素
preview_width = int(fig_width * dpi / 100)
preview_height = int(fig_height * dpi / 100)
```

### 参数说明

- **subplot_width/height**: 单个子图的尺寸（英寸）
- **wspace**: 子图横向间距（相对于子图宽度的比例）
- **hspace**: 子图纵向间距（相对于子图高度的比例）
- **margin**: 边距（英寸），为元素预留空间
- **dpi**: 每英寸点数，影响输出分辨率

---

## ✅ 总结

新的自动布局功能：

1. ✅ **智能计算**：根据行列数和元素位置计算最优布局
2. ✅ **用户反馈**：弹出对话框显示优化结果
3. ✅ **自动填充**：wspace 和 hspace 自动更新
4. ✅ **提供建议**：告诉您最佳的图片尺寸和预览尺寸
5. ✅ **可微调**：所有参数都可以手动调整

**现在请在GUI中测试"自动布局"功能！**

点击按钮后应该会弹出对话框显示优化结果，并自动填充间距参数。

