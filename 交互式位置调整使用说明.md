# 交互式位置调整功能使用说明

## 📋 功能概述

新增了**交互式预览窗口**，允许您在预览时使用键盘快捷键实时调整色带、比例尺和北箭的位置，并自动保存调整结果，下次预览时自动应用。

---

## 🎯 核心功能

### 1. **实时位置调整**
- 使用方向键微调元素位置
- 实时预览调整效果
- 支持大步长快速调整（Shift+方向键）

### 2. **位置记忆**
- 调整后的位置自动保存到 `position_adjustments.json`
- 下次预览时自动应用保存的位置
- 可随时重置为默认位置

### 3. **三种调整对象**
- **色带位置**：上下左右微调色带
- **比例尺位置**：调整比例尺在子图中的位置
- **北箭位置**：调整北箭在子图中的位置

---

## 🚀 使用方法

### 步骤 1：打开交互式预览

1. 在GUI中设置好所有参数（数据文件、布局、色带等）
2. 点击**"预览多图"**按钮
3. 系统会生成图形并打开**交互式预览窗口**

### 步骤 2：选择调整对象

使用以下方法之一选择要调整的对象：

**方法 1：按 Tab 键切换**
```
Tab → 在色带/比例尺/北箭之间循环切换
```

**方法 2：在右侧面板选择**
- 点击右侧控制面板中的单选按钮
- 选择"色带位置"、"比例尺位置"或"北箭位置"

### 步骤 3：调整位置

使用方向键调整位置：

| 按键 | 功能 | 步长 |
|------|------|------|
| ↑ | 向上移动 | 0.01 |
| ↓ | 向下移动 | 0.01 |
| ← | 向左移动 | 0.01 |
| → | 向右移动 | 0.01 |
| Shift+↑ | 向上大幅移动 | 0.05 |
| Shift+↓ | 向下大幅移动 | 0.05 |
| Shift+← | 向左大幅移动 | 0.05 |
| Shift+→ | 向右大幅移动 | 0.05 |

**提示**：
- 每次按键后图形会自动重绘，显示新位置
- 右侧面板会实时显示当前偏移量
- 状态栏会显示当前调整的对象

### 步骤 4：保存位置

调整满意后，保存位置：

**方法 1：按 S 键**
```
S → 保存当前所有位置调整
```

**方法 2：点击按钮**
- 点击右侧面板的"保存位置"按钮

**保存后**：
- 弹出确认对话框
- 位置保存到 `position_adjustments.json`
- 下次预览时自动应用这些设置

---

## ⌨️ 完整快捷键列表

| 快捷键 | 功能 |
|--------|------|
| **Tab** | 切换调整对象（色带/比例尺/北箭） |
| **↑/↓/←/→** | 微调位置（步长 0.01） |
| **Shift+方向键** | 大幅调整（步长 0.05） |
| **R** | 重置当前对象位置 |
| **Ctrl+R** | 重置所有位置 |
| **S** | 保存当前位置 |
| **H** | 显示帮助信息 |

---

## 📊 调整参数说明

### 色带位置调整

- **cbar_offset_y**：垂直偏移量（-0.1 到 0.1）
  - 正值：色带向上移动
  - 负值：色带向下移动
  
- **cbar_offset_x**：水平偏移量（-0.1 到 0.1）
  - 正值：色带向右移动
  - 负值：色带向左移动

### 比例尺位置调整

- **scale_offset_x**：水平偏移量（-0.2 到 0.2）
  - 正值：比例尺向右移动
  - 负值：比例尺向左移动
  
- **scale_offset_y**：垂直偏移量（-0.2 到 0.2）
  - 正值：比例尺向上移动
  - 负值：比例尺向下移动

### 北箭位置调整

- **north_offset_x**：水平偏移量（-0.2 到 0.2）
  - 正值：北箭向右移动
  - 负值：北箭向左移动
  
- **north_offset_y**：垂直偏移量（-0.2 到 0.2）
  - 正值：北箭向上移动
  - 负值：北箭向下移动

---

## 💡 使用技巧

### 1. 色带位置调整

**问题**：色带与标题重叠

**解决方案**：
1. 按 Tab 切换到"色带位置"
2. 按 ↑ 键向上移动色带
3. 使用 Shift+↑ 快速上移
4. 微调到合适位置后按 S 保存

**推荐设置**：
- 底部色带：`cbar_offset_y = 0.03 ~ 0.08`（向上移动）
- 顶部色带：`cbar_offset_y = -0.03 ~ -0.08`（向下移动）

### 2. 比例尺位置调整

**问题**：比例尺位置不理想

**解决方案**：
1. 按 Tab 切换到"比例尺位置"
2. 使用方向键调整到合适位置
3. 按 S 保存

**推荐设置**：
- 右下角：默认位置通常合适
- 需要避开数据：向上或向左移动

### 3. 北箭位置调整

**问题**：北箭与数据重叠

**解决方案**：
1. 按 Tab 切换到"北箭位置"
2. 使用方向键移动到空白区域
3. 按 S 保存

---

## 🔧 高级功能

### 重置位置

**重置当前对象**：
```
R → 将当前对象（色带/比例尺/北箭）重置为默认位置
```

**重置所有对象**：
```
Ctrl+R → 将所有对象重置为默认位置
```

### 查看当前偏移量

右侧控制面板的"当前偏移量"区域实时显示所有调整参数：

```
cbar_offset_y: 0.050
cbar_offset_x: 0.000
scale_offset_x: 0.020
scale_offset_y: -0.030
north_offset_x: 0.000
north_offset_y: 0.000
```

### 手动编辑配置文件

位置调整保存在 `position_adjustments.json`：

```json
{
  "cbar_offset_y": 0.05,
  "cbar_offset_x": 0.0,
  "scale_offset_x": 0.02,
  "scale_offset_y": -0.03,
  "north_offset_x": 0.0,
  "north_offset_y": 0.0
}
```

您可以直接编辑此文件，下次预览时会自动应用。

---

## 📝 典型使用场景

### 场景 1：调整底部色带位置

**目标**：色带太靠下，需要向上移动

**操作步骤**：
1. 点击"预览多图"
2. 确认当前选择"色带位置"（或按 Tab 切换）
3. 按 Shift+↑ 快速上移（约 3-5 次）
4. 按 ↑ 微调到合适位置
5. 按 S 保存
6. 关闭预览窗口

**结果**：下次预览时色带自动在新位置显示

### 场景 2：调整比例尺避开数据

**目标**：比例尺与地图数据重叠

**操作步骤**：
1. 点击"预览多图"
2. 按 Tab 切换到"比例尺位置"
3. 观察比例尺当前位置
4. 使用方向键移动到空白区域
   - 如果数据在右下角：按 ↑ 向上移动
   - 如果需要：按 ← 向左移动
5. 按 S 保存

### 场景 3：重置所有调整

**目标**：之前的调整不满意，想重新开始

**操作步骤**：
1. 点击"预览多图"
2. 按 Ctrl+R 重置所有位置
3. 重新调整各个元素
4. 按 S 保存新位置

---

## ⚠️ 注意事项

1. **保存是必须的**
   - 调整后必须按 S 或点击"保存位置"按钮
   - 否则关闭窗口后调整会丢失

2. **偏移量是累加的**
   - 偏移量会叠加到GUI中设置的基础位置上
   - 例如：GUI中设置 `scale_pad_y=0.12`，偏移量 `scale_offset_y=0.03`
   - 实际位置：`0.12 + 0.03 = 0.15`

3. **适用范围**
   - 目前仅支持多图预览
   - 单图预览暂不支持交互式调整

4. **配置文件位置**
   - `position_adjustments.json` 在项目根目录
   - 删除此文件可恢复所有默认设置

---

## 🎉 总结

**新功能优势**：
1. ✅ **实时调整**：所见即所得，立即看到效果
2. ✅ **位置记忆**：一次调整，永久生效
3. ✅ **操作简单**：键盘快捷键，快速高效
4. ✅ **精确控制**：支持微调和大幅调整
5. ✅ **灵活重置**：随时恢复默认设置

**推荐工作流程**：
1. 在GUI中设置基本参数
2. 点击"预览多图"
3. 使用交互式窗口微调位置
4. 保存满意的位置
5. 导出最终图形

**现在您可以完全控制地图元素的位置，制作符合论文要求的高质量地图了！** 🎊

