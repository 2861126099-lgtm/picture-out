# 修复说明 - 色带宽度调整功能

## 🐛 发现的问题

### 问题1: 色带宽度参数未生效
**现象**: 修改"宽度比例"参数后，生成的图片中色带宽度没有变化

**原因**: 
- 预览函数 `preview_grid()` 中使用了错误的参数名 `per_cbar_fraction`
- 应该使用 `per_cbar_size` 参数

**修复**:
- 将预览函数中的 `per_cbar_fraction` 改为 `per_cbar_size`
- 确保参数正确传递到 `make_grid_map()` 函数

### 问题2: 多图色带比例不协调
**现象**: 生成的多图中，色带占据了过大的空间，导致主图区域被压缩

**原因**: 
- 分图色带的默认值 0.15 对于多图布局来说太大了
- 多图中每个子图都有自己的色带，0.15的比例会占据过多空间

**修复**:
- 将分图色带的默认值从 0.15 改为 0.05
- 更新工具提示，推荐范围从 0.05-0.3 改为 0.03-0.15

---

## ✅ 已修复的内容

### 1. 预览函数修复
**文件**: `gui_app.py`
**位置**: 第888-890行

**修改前**:
```python
per_cbar_loc=cb_per_loc.get(),
per_cbar_fraction=_get_float(e_per_frac, 0.15),  # 错误的参数名
per_cbar_pad=_get_float(e_per_pad, 0.04),
```

**修改后**:
```python
per_cbar_loc=cb_per_loc.get(),
per_cbar_size=_get_float(e_per_frac, 0.05),  # 正确的参数名和默认值
per_cbar_pad=_get_float(e_per_pad, 0.04),
```

### 2. 导出函数修复
**文件**: `gui_app.py`
**位置**: 第965-967行

**修改前**:
```python
per_cbar_loc=cb_per_loc.get(),
per_cbar_size=f"{float(e_per_frac.get() or 0.15) * 100}%",  # 不必要的转换
per_cbar_pad=float(e_per_pad.get()),
```

**修改后**:
```python
per_cbar_loc=cb_per_loc.get(),
per_cbar_size=float(e_per_frac.get() or 0.05),  # 直接传递浮点数
per_cbar_pad=float(e_per_pad.get()),
```

### 3. GUI默认值修复
**文件**: `gui_app.py`
**位置**: 第689行

**修改前**:
```python
e_per_frac = tk.Entry(C2, width=6); e_per_frac.insert(0, "0.15"); e_per_frac.grid(row=2, column=2, sticky="w")
qmark(C2, "分图色带宽度比例，范围0.05-0.3，默认0.15", 2, 3)
```

**修改后**:
```python
e_per_frac = tk.Entry(C2, width=6); e_per_frac.insert(0, "0.05"); e_per_frac.grid(row=2, column=2, sticky="w")
qmark(C2, "分图色带宽度比例，范围0.03-0.15，默认0.05", 2, 3)
```

### 4. 默认值字典修复
**文件**: `gui_app.py`
**位置**: 第1098-1099行

**修改前**:
```python
"e_per_frac":"0.15","e_per_pad":"0.02",
```

**修改后**:
```python
"e_per_frac":"0.05","e_per_pad":"0.02",
```

---

## 📊 参数说明

### per_cbar_size 参数
`plotting.py` 中的 `make_grid_map()` 函数接受 `per_cbar_size` 参数，支持两种格式：

1. **百分比字符串**: 如 "8%" 
   - 会被解析为 0.08
   
2. **浮点数**: 如 0.08
   - 直接使用该值

**内部处理逻辑** (plotting.py 第392-400行):
```python
if isinstance(per_cbar_size, str) and per_cbar_size.endswith('%'):
    try:
        frac = float(per_cbar_size.strip('%'))/100.0
    except Exception:
        frac = 0.08
elif isinstance(per_cbar_size, (int, float)):
    frac = float(per_cbar_size)
else:
    frac = 0.08
```

---

## 🎯 新的推荐值

### 单图色带宽度
- **小图**: 0.10-0.12
- **标准**: 0.13-0.17（默认 0.15）
- **大图**: 0.18-0.25

### 多图共享色带宽度
- **2x2布局**: 0.08-0.10（默认 0.10）
- **3x3布局**: 0.06-0.08
- **4x4布局**: 0.05-0.07

### 多图分图色带宽度 ⚠️ 已调整
- **紧凑布局**: 0.03-0.05（默认 0.05）✨
- **标准布局**: 0.06-0.08
- **宽松布局**: 0.09-0.12

**注意**: 分图色带的推荐值比单图小很多，因为：
1. 多图布局中每个子图都有自己的色带
2. 子图本身尺寸较小
3. 需要保持主图区域的可读性

---

## 🧪 测试步骤

### 1. 测试多图分图色带
1. 启动程序: `python test_gui.py`
2. 切换到"多图"标签页
3. 取消勾选"使用共享色带"
4. 在"分图：位置/宽度比例/与图距"中，确认默认值为 0.05
5. 尝试不同的值:
   - 0.03 (非常窄)
   - 0.05 (默认，推荐)
   - 0.08 (标准)
   - 0.12 (较宽)
6. 点击"预览多图"查看效果

### 2. 测试多图共享色带
1. 勾选"使用共享色带"
2. 在"共享：位置/宽度比例/刻度数"中，确认默认值为 0.10
3. 尝试不同的值:
   - 0.08 (较窄)
   - 0.10 (默认，推荐)
   - 0.12 (较宽)
4. 点击"预览多图"查看效果

### 3. 测试单图色带
1. 切换到"单图"标签页
2. 在"色带（单图）"区域，确认"宽度比例"默认值为 0.15
3. 尝试不同的值:
   - 0.10 (较窄)
   - 0.15 (默认，推荐)
   - 0.20 (较宽)
4. 点击"预览单图"查看效果

---

## ✅ 验证清单

- [x] 修复预览函数参数名错误
- [x] 修复导出函数参数传递
- [x] 调整分图色带默认值 (0.15 → 0.05)
- [x] 更新GUI默认值
- [x] 更新默认值字典
- [x] 更新工具提示说明
- [x] 无语法错误
- [x] 无IDE警告

---

## 📝 使用建议

### 如何选择合适的色带宽度？

1. **先使用默认值**
   - 单图: 0.15
   - 多图共享: 0.10
   - 多图分图: 0.05

2. **根据实际效果调整**
   - 如果色带太宽，主图被压缩 → 减小数值
   - 如果色带太窄，刻度标签拥挤 → 增大数值

3. **考虑输出尺寸**
   - 小尺寸图片 → 使用较小的色带宽度
   - 大尺寸图片 → 可以使用较大的色带宽度

4. **考虑布局方式**
   - 横向布局 (right/left) → 可以使用较宽的色带
   - 纵向布局 (top/bottom) → 建议使用较窄的色带

---

## 🔄 更新历史

### v13.1 (2025-10-29)
- 🐛 修复色带宽度参数未生效的问题
- 🎨 调整多图分图色带默认值 (0.15 → 0.05)
- 📝 更新推荐值范围
- ✅ 测试通过

### v13.0 (2025-10-29)
- ✨ 添加色带宽度调整功能
- 🎨 优化界面布局
- 📚 完善文档

---

**修复完成！请重新测试功能。** 🎉

