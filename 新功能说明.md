# Paper Map 新功能说明

## 概述

本次更新主要针对多图（Grid Map）功能进行了优化，添加了以下新功能：

1. **统一比例尺功能**
2. **线段式比例尺样式**
3. **自动布局优化**
4. **预览窗口调整优化**

---

## 1. 统一比例尺功能

### 功能说明

类似于色带的"使用共享色带"功能，现在比例尺也支持统一显示模式。

- **启用后**：只在最后一个子图（右下角）显示比例尺
- **禁用后**：每个子图都显示自己的比例尺（默认行为）

### 使用场景

特别适合以下情况：
- 横向排列较多的布局（1×4, 2×4, 3×4等）
- 所有子图使用相同的地理范围和比例
- 希望减少视觉干扰，让图片更简洁

### 使用方法

1. 打开"多图"标签页
2. 在"子图元素（比例尺 & 北箭）"区域
3. 勾选"使用共享比例尺"复选框
4. 点击"预览多图"查看效果

### 效果对比

**禁用共享比例尺**（默认）：
```
┌─────┬─────┬─────┬─────┐
│ 图1 │ 图2 │ 图3 │ 图4 │
│ 尺1 │ 尺2 │ 尺3 │ 尺4 │
└─────┴─────┴─────┴─────┘
```

**启用共享比例尺**：
```
┌─────┬─────┬─────┬─────┐
│ 图1 │ 图2 │ 图3 │ 图4 │
│     │     │     │ 尺  │
└─────┴─────┴─────┴─────┘
```

---

## 2. 线段式比例尺样式

### 功能说明

新增了一种更简洁的比例尺样式，使用简单的线段和刻度标记，而不是传统的分段式（棋盘格）样式。

### 两种样式对比

**分段式**（默认）：
```
┌─┬─┬─┬─┐
│█│ │█│ │ 0  10  20  30  40 km
└─┴─┴─┴─┘
```

**线段式**（新增）：
```
├───────────┤
0          40 km
```

### 使用方法

1. 打开"多图"标签页
2. 在"子图元素（比例尺 & 北箭）"区域
3. 在"样式"下拉框中选择"线段式"
4. 点击"预览多图"查看效果

### 推荐场景

- 横向排列多的布局（空间有限）
- 追求简洁现代的视觉风格
- 与线段式的图例或其他元素搭配

---

## 3. 自动布局优化

### 功能说明

根据行列数自动计算最优的子图间距（wspace和hspace），减少留白，特别优化了横向排列多的情况。

### 优化策略

| 布局类型 | wspace | hspace | 说明 |
|---------|--------|--------|------|
| 1×4 | 0.02 | 0.22 | 横向紧凑，纵向宽松 |
| 2×4 | 0.02 | 0.18 | 横向紧凑，纵向适中 |
| 3×4 | 0.02 | 0.12 | 横向紧凑，纵向紧凑 |
| 2×2 | 0.08 | 0.18 | 均衡布局 |
| 1×3 | 0.05 | 0.22 | 横向适中，纵向宽松 |

### 使用方法

1. 打开"多图"标签页
2. 在"布局与说明"区域设置好"行×列"
3. 点击"自动布局"按钮
4. wspace和hspace会自动填充为推荐值
5. 可以在此基础上微调

### 手动调整

自动布局只是提供推荐值，您仍然可以：
- 直接修改wspace和hspace的值
- 根据实际效果进行微调
- 保存自己喜欢的设置

---

## 4. 预览窗口调整优化

### 功能说明

改善了预览窗口的调整体验，特别是当预览宽度大于高度时。

### 改进内容

- 确保预览窗口始终可以自由调整大小
- 优化了横向布局的预览体验
- 减少了窗口调整时的卡顿

### 使用建议

对于横向排列多的布局（如1×4, 2×4）：
- 建议设置较大的预览宽度（如15-20）
- 设置较小的预览高度（如6-8）
- 这样可以更好地查看横向排列的效果

---

## 完整工作流程示例

### 场景：制作1×4横向排列的多图

1. **设置布局**
   - 行×列：1×4
   - 点击"自动布局"按钮
   - wspace自动设为0.02，hspace自动设为0.22

2. **设置比例尺**
   - 样式：选择"线段式"
   - 勾选"使用共享比例尺"
   - 设置比例尺长度、字号等参数

3. **设置色带**
   - 勾选"使用共享色带"
   - 位置：选择"bottom"或"right"
   - 调整宽度比例（推荐0.10）

4. **预览和调整**
   - 预览宽×高：15×6
   - 点击"预览多图"
   - 根据效果微调wspace/hspace

5. **导出**
   - 设置导出路径
   - 点击"导出多图"

---

## 参数推荐值

### 1×4布局推荐

```
布局：
- 行×列：1×4
- wspace：0.02
- hspace：0.22

比例尺：
- 样式：线段式
- 使用共享比例尺：✓
- 长度：根据实际范围
- 字号：9

色带：
- 使用共享色带：✓
- 位置：bottom
- 宽度比例：0.10

预览：
- 宽×高：15×6
- DPI：130
```

### 2×4布局推荐

```
布局：
- 行×列：2×4
- wspace：0.02
- hspace：0.18

比例尺：
- 样式：线段式
- 使用共享比例尺：✓
- 长度：根据实际范围
- 字号：9

色带：
- 使用共享色带：✓
- 位置：right
- 宽度比例：0.10

预览：
- 宽×高：15×8
- DPI：130
```

### 3×4布局推荐

```
布局：
- 行×列：3×4
- wspace：0.02
- hspace：0.12

比例尺：
- 样式：线段式
- 使用共享比例尺：✓
- 长度：根据实际范围
- 字号：8

色带：
- 使用共享色带：✓
- 位置：right
- 宽度比例：0.08

预览：
- 宽×高：15×11
- DPI：130
```

---

## 常见问题

### Q1: 共享比例尺会显示在哪里？

A: 共享比例尺会显示在最后一个子图（右下角）的左下角位置。

### Q2: 线段式比例尺和分段式有什么区别？

A: 
- **分段式**：传统的棋盘格样式，黑白相间，视觉效果明显
- **线段式**：简洁的线段样式，只有一条线和两端的刻度，更现代

### Q3: 自动布局会覆盖我的设置吗？

A: 自动布局只是填充推荐值，不会保存。您可以在此基础上修改，或者不使用自动布局功能。

### Q4: 为什么横向排列多时要用更小的wspace？

A: 因为横向空间有限，如果间距太大会导致每个子图被压缩得很窄，影响显示效果。

### Q5: 可以只用共享比例尺而不用共享色带吗？

A: 可以！两个功能是独立的，您可以任意组合使用。

---

## 技术细节

### 修改的文件

1. **plotting.py**
   - 新增 `draw_scale_bar_line()` 函数
   - 新增 `auto_layout_spacing()` 函数
   - 修改 `_make_grid_map_impl()` 支持新参数
   - 修改 `make_grid_map()` 添加新参数

2. **gui_app.py**
   - 添加比例尺样式下拉框
   - 添加共享比例尺复选框
   - 添加自动布局按钮
   - 更新预览和导出函数

3. **draw_elems.py**
   - 导出 `draw_scale_bar_line` 函数

### 新增参数

**make_grid_map()函数**：
- `scale_style`: 比例尺样式，"分段式"或"线段式"，默认"分段式"
- `use_shared_scale`: 是否使用共享比例尺，默认False

**auto_layout_spacing()函数**：
- `nrows`: 行数
- `ncols`: 列数
- `use_shared_cbar`: 是否使用共享色带
- `shared_cbar_loc`: 共享色带位置
- 返回：(wspace, hspace)元组

---

## 兼容性

- ✅ 所有原有功能完全保留
- ✅ 默认参数保持向后兼容
- ✅ 不影响单图功能
- ✅ 不影响已有的多图配置

---

## 反馈和建议

如果您在使用过程中遇到问题或有改进建议，欢迎反馈！

