# 留白问题修复 - 测试指南

## 🎯 本次修复内容

### 核心问题
- **问题**：多图布局出现大面积留白，子图只占画布一小部分
- **原因**：GridSpec缺少边距参数（left, right, top, bottom），使用了matplotlib的默认大边距
- **解决**：添加了GridSpec边距参数，将边距从默认的12.5%-10%优化到5%

### 修复效果
✅ 子图区域从占画布的 **62%** 提升到 **81%**  
✅ 预览尺寸从 **18×7像素** 修正到 **1450×620像素**（2×2布局）  
✅ 自动适配共享色带位置，预留合适空间  
✅ 根据是否有说明文字动态调整底部边距  

---

## 🧪 测试步骤

### 准备工作

1. **确认GUI已启动**
   - 应该看到"Paper Map GUI"窗口
   - 如果没有，运行：`python test_gui.py`

2. **准备测试数据**
   - 需要至少4个TIF文件（用于2×2布局测试）
   - 需要一个边界SHP文件

---

### 测试1：验证自动布局功能

**目的**：确认自动布局能正确计算预览尺寸

1. 切换到 **"多图"** 标签页

2. 设置布局：
   - 行数：`2`
   - 列数：`2`

3. 点击 **"自动布局"** 按钮

4. **预期结果**：
   - 弹出对话框显示优化结果
   - 预览尺寸应该是 **1450 × 620 像素**左右（不是18×7！）
   - wspace和hspace自动填充

5. **检查点**：
   - ✅ 预览宽度 > 1000 像素
   - ✅ 预览高度 > 500 像素
   - ✅ 没有报错

---

### 测试2：验证留白减少效果（2×2布局）

**目的**：确认子图占据了大部分画布空间

1. 在"多图"标签页，保持2×2布局

2. 选择数据文件：
   - 选择4个TIF文件
   - 选择边界SHP文件

3. 设置色带：
   - ✓ 勾选 **"使用共享色带"**
   - 位置：`right`（右侧）
   - 宽度比例：`0.10`

4. 设置比例尺：
   - 样式：`线段式`
   - ✓ 勾选 **"使用共享比例尺"**

5. 设置预览尺寸：
   - 在工具栏的"预览(px)"中填入自动布局建议的尺寸
   - 例如：宽度 `1450`，高度 `620`

6. 点击 **"预览多图"**

7. **预期效果**：
   - ✅ 预览窗口中，4个子图应该占据大部分空间
   - ✅ **上部留白很小**（约5%，不是之前的大片空白）
   - ✅ 左右留白很小（约5%）
   - ✅ 右侧有色带区域（约15%）
   - ✅ 只在右下角子图显示比例尺
   - ✅ 子图之间间距合适

8. **对比检查**：
   - ❌ 修复前：上部有大片空白，子图挤在下方
   - ✅ 修复后：子图铺满画布，留白很小

---

### 测试3：验证横向布局（1×4）

**目的**：确认横向排列多时也能正常显示

1. 设置布局：
   - 行数：`1`
   - 列数：`4`

2. 点击 **"自动布局"**

3. **预期结果**：
   - 预览尺寸约 **1450 × 450 像素**
   - wspace = 0.02（很小）
   - hspace = 0.22

4. 选择4个TIF文件，点击"预览多图"

5. **预期效果**：
   - ✅ 4个子图横向紧密排列
   - ✅ 上下留白很小
   - ✅ 子图占据画布大部分空间
   - ✅ 比例尺不遮挡图片内容

---

### 测试4：验证不同配置

**测试4.1：无共享色带**

1. 取消勾选"使用共享色带"
2. 点击"预览多图"
3. **预期**：右边距应该更小（95%），子图更宽

**测试4.2：有说明文字**

1. 在"说明文字"框中输入一些文字
2. 点击"预览多图"
3. **预期**：底部留白稍大（10%），为说明文字预留空间

**测试4.3：不同行列数**

测试以下布局，确认都没有大面积留白：
- 3×2（6个子图）
- 2×3（6个子图）
- 3×3（9个子图）

---

## ✅ 验收标准

### 必须满足的条件

1. **预览尺寸正确**
   - 自动布局建议的预览尺寸 > 1000像素
   - 不再是18×7这样的错误值

2. **留白显著减少**
   - 上部留白 ≤ 10%（目测）
   - 左右留白 ≤ 10%
   - 子图占据画布 ≥ 80% 的空间

3. **元素不重叠**
   - 色带不遮挡子图
   - 比例尺不遮挡图片内容
   - 标题显示正常

4. **功能正常**
   - 自动布局按钮工作正常
   - 预览功能正常
   - 导出功能正常

### 可选优化

- 子图间距可以手动微调
- 预览尺寸可以根据屏幕大小调整
- 边距可以根据需要进一步优化

---

## 🐛 如果还有问题

### 问题1：预览尺寸还是很小

**检查**：
- 查看 `plotting.py` 第266-270行
- 确认是 `fig_width * dpi * 0.8`，不是 `/ 100`

### 问题2：还是有大面积留白

**检查**：
- 查看 `plotting.py` 第557-571行
- 确认GridSpec有 `left=gs_left, right=gs_right, top=gs_top, bottom=gs_bottom` 参数

**调试**：
- 可以尝试进一步减小边距：
  ```python
  gs_left = 0.03    # 从0.05改为0.03
  gs_right = 0.97   # 从0.95改为0.97
  gs_top = 0.97
  gs_bottom = 0.03
  ```

### 问题3：元素重叠

**调整**：
- 增大对应方向的边距
- 例如右侧色带重叠，增大 `gs_right` 的预留空间：
  ```python
  gs_right = 0.80 if use_shared_cbar and shared_cbar_loc == "right" else 0.95
  ```

---

## 📊 修复前后对比

### 修复前
```
┌─────────────────────────────────────────┐
│                                         │ ← 大片空白
│                                         │
│  ┌────┬────┐                           │
│  │图1 │图2 │                           │
│  ├────┼────┤                           │
│  │图3 │图4 │                           │
│  └────┴────┘                           │
│                                         │
└─────────────────────────────────────────┘
```
- 子图只占画布的 **62%**
- 预览尺寸显示 **18×7像素**（错误）

### 修复后
```
┌─────────────────────────────────────────┐
│ ┌──────────┬──────────┐               │ ← 留白很小
│ │   图1    │   图2    │               │
│ │          │          │               │
│ ├──────────┼──────────┤               │
│ │   图3    │   图4    │               │
│ │          │          │               │
│ └──────────┴──────────┘               │
└─────────────────────────────────────────┘
```
- 子图占画布的 **81%**
- 预览尺寸 **1450×620像素**（正确）

---

## 📝 技术细节

### 修改的代码位置

1. **plotting.py 第557-571行**：添加GridSpec边距参数
   ```python
   gs = GridSpec(nrows, ncols, figure=fig, 
                 left=0.05, right=0.95, top=0.95, bottom=0.05,
                 wspace=wspace, hspace=hspace)
   ```

2. **plotting.py 第266-270行**：修正预览尺寸计算
   ```python
   preview_width = int(fig_width * dpi * 0.8)
   preview_height = int(fig_height * dpi * 0.8)
   ```

### 边距参数说明

| 参数 | 含义 | 取值 | 说明 |
|------|------|------|------|
| `left` | 左边距 | 0.05 | 子图区域从画布5%处开始 |
| `right` | 右边距 | 0.85/0.95 | 子图区域到画布85%/95%处结束 |
| `top` | 上边距 | 0.95 | 子图区域到画布95%处结束 |
| `bottom` | 底部边距 | 0.05/0.10 | 子图区域从画布5%/10%处开始 |

---

## 🎉 总结

本次修复通过添加GridSpec边距参数，从根本上解决了多图布局的留白问题：

1. ✅ **空间利用率提升**：从62%提升到81%
2. ✅ **预览尺寸修正**：从错误的18×7像素修正到正确的1450×620像素
3. ✅ **自动适配**：根据色带位置、说明文字等动态调整边距
4. ✅ **向后兼容**：不影响现有功能

现在生成的多图布局应该能够充分利用画布空间，大幅减少不必要的留白！

请按照上述步骤测试，如有任何问题请反馈具体现象。

