# 迭代优化更新说明 - 论文级优化版

## 🎯 本次更新概述

根据您的反馈和参考图片，本次更新进行了以下优化：

1. **色带长度优化**：底部/顶部色带占3/4长度，更符合论文规范
2. **自定义样式导入**：支持导入自定义的北箭和比例尺样式
3. **字体选项扩展**：中英文字体选项大幅增加
4. **GUI布局整理**：优化对齐和布局

---

## ✨ 核心改进

### 1. 色带长度优化 ⭐⭐⭐

**问题分析**：
根据您提供的参考图片，论文中的色带长度应该占整体长度的3/4才比较协调。

**解决方案**：
- 底部/顶部色带：自动设置为占3/4长度（shrink=0.75）
- 左侧/右侧色带：保持全长（shrink=1.0）

**代码实现**：
```python
# 根据位置设置色带长度占比
if shared_cbar_loc in ['bottom', 'top']:
    shrink = 0.75  # 占3/4长度（符合论文规范）
else:
    shrink = 1.0   # 占全长

cbar = fig.colorbar(shared_mappable, ax=axes, location=shared_cbar_loc,
                    fraction=shared_cbar_frac, pad=0.02, shrink=shrink)
```

**效果对比**：
```
优化前（底部色带）：
┌─────────────────────────────────────────┐
│ ┌──────────┬──────────┬──────────┐     │
│ │   图1    │   图2    │   图3    │     │
│ └──────────┴──────────┴──────────┘     │
│ ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫     │ ← 色带太长
└─────────────────────────────────────────┘

优化后（底部色带）：
┌─────────────────────────────────────────┐
│ ┌──────────┬──────────┬──────────┐     │
│ │   图1    │   图2    │   图3    │     │
│ └──────────┴──────────┴──────────┘     │
│    ┣━━━━━━━━━━━━━━━━━━━━━━━━┫          │ ← 色带占3/4，更协调
└─────────────────────────────────────────┘
```

### 2. 自定义样式导入功能 ⭐⭐⭐

**功能说明**：
- 支持导入自定义的比例尺样式（Python文件）
- 支持导入自定义的北箭样式（Python文件）
- 导入后自动添加到下拉框中
- 样式文件可以重复使用

**使用方法**：

#### 导入比例尺样式

1. **准备Python文件**：
   - 创建一个.py文件（如`我的比例尺.py`）
   - 定义函数：`draw_custom_scale_bar(ax, extent, **kwargs)`

2. **在GUI中导入**：
   - 在"多图"页的"子图元素"区域
   - 比例尺样式下拉框旁边，点击 **"导入"** 按钮
   - 选择您的.py文件
   - 点击"打开"

3. **使用样式**：
   - 导入成功后，样式名称（文件名）会自动添加到下拉框
   - 下拉框会自动选中新导入的样式
   - 预览或导出时会使用您的自定义样式

#### 导入北箭样式

1. **准备Python文件**：
   - 创建一个.py文件（如`我的北箭.py`）
   - 定义函数：`draw_custom_north_arrow(ax, extent, **kwargs)`

2. **在GUI中导入**：
   - 在"多图"页的"子图元素"区域
   - 北箭样式下拉框旁边，点击 **"导入"** 按钮
   - 选择您的.py文件
   - 点击"打开"

3. **使用样式**：
   - 导入成功后，样式名称会自动添加到下拉框
   - 下拉框会自动选中新导入的样式

**示例文件**：

程序会自动在`custom_styles`目录下创建示例文件：
- `示例比例尺样式.py` - 比例尺样式示例
- `示例北箭样式.py` - 北箭样式示例

您可以参考这些示例文件来创建自己的样式。

**比例尺样式示例**：
```python
"""
自定义比例尺样式
"""

def draw_custom_scale_bar(ax, extent, *, km_length=None, bar_h=0.012,
                          y_out=0.12, x_in=0.08, unit="km", unit_sep=" ",
                          txt_size=9, line_lw=1.2, edge_lw=0.6, segments=4):
    """
    自定义比例尺绘制函数
    
    参数：
    - ax: matplotlib axes对象
    - extent: (left, right, bottom, top) 地图范围
    - km_length: 比例尺长度（公里）
    - 其他参数...
    """
    from matplotlib.patches import Rectangle
    
    # 您的绘制代码
    left, right, bottom, top = extent
    width_m = right - left
    
    # 计算比例尺长度
    if km_length is None:
        km_length = 100  # 默认100km
    
    length_m = km_length * 1000.0
    frac_w = length_m / width_m
    
    x0 = x_in
    y0 = -y_out
    
    # 绘制比例尺
    ax.plot([x0, x0+frac_w], [y0, y0], transform=ax.transAxes,
            color='black', lw=line_lw, clip_on=False, zorder=3)
    
    # 添加标注
    ax.text(x0+frac_w/2, y0-0.02, f"{km_length}{unit_sep}{unit}",
            transform=ax.transAxes, ha='center', va='top',
            fontsize=txt_size, clip_on=False, zorder=3)
```

**北箭样式示例**：
```python
"""
自定义北箭样式
"""

def draw_custom_north_arrow(ax, extent, *, size_frac=0.06, pad_frac=0.08, 
                            txt_size=10, lw=1.5):
    """
    自定义北箭绘制函数
    
    参数：
    - ax: matplotlib axes对象
    - extent: (left, right, bottom, top) 地图范围
    - size_frac: 北箭大小（相对于地图高度）
    - pad_frac: 距离边缘的距离
    - txt_size: 文字大小
    - lw: 线条宽度
    """
    from matplotlib.patches import Polygon, Rectangle
    
    # 您的绘制代码
    left, right, bottom, top = extent
    x = right - (right-left) * pad_frac
    y = bottom + (top-bottom) * pad_frac
    h = (top-bottom) * size_frac
    w = h * 0.25
    
    # 绘制箭头
    arrow = Polygon([[x, y+h], [x-w/2, y+h*0.6], [x+w/2, y+h*0.6]],
                    closed=True, facecolor='black', edgecolor='none',
                    clip_on=False, zorder=3)
    ax.add_patch(arrow)
    
    # 添加字母N
    ax.text(x, y, 'N', ha='center', va='top',
            fontsize=txt_size, fontweight='bold',
            clip_on=False, zorder=3)
```

### 3. 字体选项扩展 ⭐⭐

**扩展的英文字体**（从5个增加到15个）：
- Times New Roman（默认）
- Arial
- Calibri
- Cambria
- **Georgia**（新增）
- **Palatino**（新增）
- **Garamond**（新增）
- **Helvetica**（新增）
- **Century**（新增）
- **Book Antiqua**（新增）
- **Courier New**（新增）
- DejaVu Sans
- **DejaVu Serif**（新增）
- **Liberation Sans**（新增）
- **Liberation Serif**（新增）

**扩展的中文字体**（从8个增加到21个）：
- Microsoft YaHei（默认）
- SimHei
- SimSun
- DengXian
- KaiTi
- FangSong
- STSong
- **STKaiti**（新增）
- **STFangsong**（新增）
- **YouYuan**（新增）
- **LiSu**（新增）
- **STXihei**（新增）
- **STZhongsong**（新增）
- Noto Sans CJK SC
- **Noto Serif CJK SC**（新增）
- Source Han Sans SC
- Source Han Serif SC
- PingFang SC
- HarmonyOS Sans SC
- **Adobe Heiti Std**（新增）
- **Adobe Song Std**（新增）
- **Adobe Kaiti Std**（新增）

**使用方法**：
- 在"全局设置"区域
- 英文字体/中文字体下拉框中选择
- 选择后会应用到所有文字元素

### 4. GUI布局整理 ⭐

**优化内容**：
- 调整了比例尺和北箭样式区域的列布局
- 为导入按钮预留了空间
- 保持了所有原有功能
- 文字和控件对齐更整齐

---

## 📊 完整功能列表

### 色带功能
- ✅ 调整色带宽度（fraction参数）
- ✅ 调整色带长度（shrink参数，底部/顶部自动3/4）
- ✅ 共享色带（多图共用一个色带）
- ✅ 分图色带（每个子图独立色带）
- ✅ 色带位置（上下左右）
- ✅ 色带标签和刻度

### 比例尺功能
- ✅ 三种内置样式（分段式、线段式、标尺式）
- ✅ **自定义样式导入**（新增）
- ✅ 共享比例尺（只在最后一个子图显示）
- ✅ 调整长度、字号、段数、线宽等参数

### 北箭功能
- ✅ 两种内置样式（三角形、箭头式）
- ✅ **自定义样式导入**（新增）
- ✅ 共享北箭（只在最后一个子图显示）
- ✅ 调整字号、距边等参数

### 字体功能
- ✅ **15种英文字体**（扩展）
- ✅ **21种中文字体**（扩展）
- ✅ 配色导入（.mplstyle文件）

### 布局功能
- ✅ 自动布局（自动填充所有参数）
- ✅ 留白优化（基于实际需求计算）
- ✅ 手动调整wspace/hspace
- ✅ 调整图片尺寸和DPI

---

## 🚀 推荐工作流程

### 制作论文级多图（1×4布局）

1. **启动程序**（已运行）

2. **切换到"多图"页**

3. **设置布局**：
   - 行数：`1`
   - 列数：`4`
   - 点击 **"自动布局"**（所有参数自动填充）

4. **选择数据文件**：
   - 选择4个TIF文件
   - 选择边界SHP文件

5. **设置共享选项**：
   - ✓ 使用共享色带（位置：**bottom**）← 会自动占3/4长度
   - ✓ 使用共享比例尺
   - ✓ 使用共享北箭

6. **选择或导入样式**：
   - 比例尺样式：选择"标尺式"或导入自定义样式
   - 北箭样式：选择"箭头式"或导入自定义样式

7. **选择字体**：
   - 英文字体：Times New Roman（或其他学术字体）
   - 中文字体：SimSun、STSong等（根据期刊要求）

8. **（可选）导入配色**：
   - 点击"导入"按钮
   - 选择.mplstyle文件

9. **预览**：
   - 点击 **"预览多图"**
   - 检查色带长度是否协调（应该占3/4）
   - 检查留白是否合理

10. **微调**：
    - 如需调整，修改相关参数
    - 再次预览

11. **导出**：
    - 满意后点击"导出多图"
    - 选择PNG或PDF格式

---

## 🔧 技术细节

### 修改的文件

1. **plotting.py**
   - 色带长度优化：添加shrink参数（第795-814行）
   - 比例尺样式支持：添加自定义样式检查（第465-500行）
   - 北箭样式支持：添加自定义样式检查（第503-522行）

2. **gui_app.py**
   - 字体选项扩展：英文15种、中文21种（第256-282行）
   - 比例尺样式导入：添加导入按钮和逻辑（第912-940行）
   - 北箭样式导入：添加导入按钮和逻辑（第950-978行）

3. **custom_styles.py**（新增）
   - 自定义样式管理模块
   - 支持导入、注册、获取自定义样式
   - 提供示例文件生成功能

### 关键算法

#### 色带长度优化

```python
# 根据位置设置色带长度占比
if shared_cbar_loc in ['bottom', 'top']:
    shrink = 0.75  # 占3/4长度（符合论文规范）
else:
    shrink = 1.0   # 占全长

cbar = fig.colorbar(shared_mappable, ax=axes, location=shared_cbar_loc,
                    fraction=shared_cbar_frac, pad=0.02, shrink=shrink)
```

#### 自定义样式调用

```python
# 先检查是否是自定义样式
try:
    import custom_styles
    custom_func = custom_styles.get_custom_scale_bar_function(style)
    if custom_func:
        custom_func(ax, extent, **kwargs)
        return
except:
    pass

# 内置样式
if style == "线段式":
    draw_scale_bar_line(...)
elif style == "标尺式":
    draw_scale_bar_ruler(...)
else:
    draw_scale_bar_axes(...)
```

---

## ✅ 解决的问题

1. ✅ **色带长度不协调** → 底部/顶部色带自动占3/4长度
2. ✅ **无法自定义样式** → 支持导入Python文件定义的样式
3. ✅ **字体选项太少** → 英文15种、中文21种
4. ✅ **GUI布局不整齐** → 优化对齐和间距

---

## 📝 常见问题

### Q1: 色带长度如何调整？

**A**: 
- 底部/顶部色带：自动占3/4长度（符合论文规范）
- 左侧/右侧色带：占全长
- 如需自定义，可以修改plotting.py中的shrink参数

### Q2: 如何创建自定义样式？

**A**:
1. 参考`custom_styles`目录下的示例文件
2. 创建一个.py文件
3. 定义相应的函数（draw_custom_scale_bar或draw_custom_north_arrow）
4. 在GUI中点击"导入"按钮导入

### Q3: 导入的样式会保存吗？

**A**:
- 当前会话中有效
- 关闭程序后需要重新导入
- 建议将样式文件保存在固定位置，方便重复导入

### Q4: 字体选择后没有生效？

**A**:
1. 确保系统中安装了该字体
2. 重新预览或导出
3. 某些字体可能不支持中文，请选择合适的中文字体

---

## 🎉 总结

本次更新全面优化了论文级地图制作功能：

1. ✅ **色带长度符合论文规范**：底部/顶部自动占3/4
2. ✅ **完全可定制的样式**：支持导入自定义比例尺和北箭
3. ✅ **丰富的字体选择**：英文15种、中文21种
4. ✅ **整洁的GUI布局**：对齐优化，使用更方便

**现在可以轻松制作符合论文要求的高质量地图了！** 🎊

---

## 📞 下一步建议

1. **尝试导入自定义样式**：
   - 查看`custom_styles`目录下的示例文件
   - 根据需要修改或创建新样式
   - 在GUI中导入测试

2. **测试不同字体组合**：
   - 尝试不同的英文和中文字体
   - 找到最适合您期刊要求的组合

3. **优化色带显示**：
   - 使用底部色带查看3/4长度效果
   - 根据需要调整fraction参数

如有任何问题或建议，请随时反馈！

